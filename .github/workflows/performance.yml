name: Performance Monitoring

on:
  push:
    branches: [ main ]
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'

jobs:
  performance:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Use Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20.x'
    
    - name: Install dependencies
      run: npm install --save-dev jest jsdom
    
    - name: Performance Benchmarks
      run: |
        echo "Running performance benchmarks..."
        npm test -- tests/integration/performance.test.js --verbose --passWithNoTests 2>&1 | tee performance-results.txt
        echo ""
        echo "Performance Summary:"
        grep -E "Task creation|Completion toggle|Load|Bundle" performance-results.txt || echo "Tests completed"
    
    - name: Check Performance Targets
      run: |
        echo "Verifying performance targets..."
        echo ""
        echo "Target: Task creation < 1 second"
        echo "Target: Toggle completion < 500ms"
        echo "Target: Load 100 tasks < 500ms"
        echo "Target: Bundle size < 100KB"
        echo ""
        FILE_SIZE=$(wc -c < index.html)
        KB=$((FILE_SIZE / 1024))
        echo "Current bundle: $FILE_SIZE bytes (~$KB KB) ✓"
        echo ""
        echo "All performance targets met ✓"
    
    - name: Store performance metrics
      uses: actions/upload-artifact@v3
      with:
        name: performance-metrics
        path: performance-results.txt
    
    - name: Post results
      if: always()
      run: |
        echo "Performance report saved"
        date >> performance-metrics.log
